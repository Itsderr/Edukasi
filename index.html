<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Traffic Alert SMA (Voting + Status Tengah)</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; text-align: center; }
    h1 { color: #333; }
    .card { padding: 15px; margin: 10px auto; border-radius: 10px; width: 80%; font-weight: bold; }
    .macet { background: #ff4d4d; color: white; }
    .padat { background: #ffcc00; color: black; }
    .lancar { background: #4caf50; color: white; }
    .lumayan { background: #ff9966; color: white; }
    .form { margin: 20px; }
  </style>
</head>
<body>

  <h1>ðŸš¦ Traffic Alert SMA</h1>
  <div class="form">
    <input type="text" id="lokasi" placeholder="Lokasi jalan" />
    <select id="status">
      <option value="macet">ðŸ”´ Macet</option>
      <option value="padat">ðŸŸ¡ Padat</option>
      <option value="lancar">ðŸŸ¢ Lancar</option>
    </select>
    <button onclick="kirimLaporan()">Kirim</button>
  </div>

  <h2>Laporan Hasil Gabungan</h2>
  <div id="laporan"></div>

  <script>
    let laporanList = [];

    function kirimLaporan() {
      const lokasi = document.getElementById("lokasi").value.trim();
      const status = document.getElementById("status").value;
      const timestamp = Date.now();

      if (lokasi) {
        laporanList.push({ lokasi, status, timestamp });
        document.getElementById("lokasi").value = "";
        tampilkanLaporan();
      }
    }

    function tentukanStatus(votes) {
      const { macet, padat, lancar } = votes;
      const total = macet + padat + lancar;
      if (total === 0) return "lancar"; // default

      const maxVote = Math.max(macet, padat, lancar);
      const selisih = maxVote - (total - maxVote);

      // Kalau perbedaan suara kecil â†’ status tengah
      if (selisih <= 2) return "lumayan";

      if (maxVote === macet) return "macet";
      if (maxVote === padat) return "padat";
      if (maxVote === lancar) return "lancar";
      return "padat"; 
    }

    function tampilkanLaporan() {
      const laporanDiv = document.getElementById("laporan");
      laporanDiv.innerHTML = "";
      const now = Date.now();

      // Kelompokkan laporan per lokasi
      const grouped = {};
      laporanList.forEach(laporan => {
        if (now - laporan.timestamp <= 5 * 60 * 1000) {
          if (!grouped[laporan.lokasi]) {
            grouped[laporan.lokasi] = { macet: 0, padat: 0, lancar: 0 };
          }
          grouped[laporan.lokasi][laporan.status]++;
        }
      });

      // Tampilkan hasil gabungan
      for (let lokasi in grouped) {
        const finalStatus = tentukanStatus(grouped[lokasi]);
        const div = document.createElement("div");
        div.className = `card ${finalStatus}`;
        let teksStatus = finalStatus.toUpperCase();

        if (finalStatus === "lumayan") teksStatus = "LUMAYAN LANCAR / CUKUP PADAT";

        div.innerText = `${lokasi} â†’ ${teksStatus} 
          (M:${grouped[lokasi].macet}, P:${grouped[lokasi].padat}, L:${grouped[lokasi].lancar})`;
        laporanDiv.appendChild(div);
      }
    }

    // Auto update tiap 5 detik
    setInterval(tampilkanLaporan, 5000);
  </script>
</body>
</html>
